<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>掲示板サイト</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/x-icon" href="favicon.ico"> <!-- faviconの設定 -->
</head>
<body>
    <div id="loginPage" class="page">
        <h1>ログイン</h1>
        <form id="loginForm">
            <label for="email">メールアドレス:</label>
            <input type="email" id="email" name="email" required>
            <label for="password">パスワード:</label>
            <input type="password" id="password" name="password" required>
            <button type="submit">ログイン</button>
            <p>アカウントをお持ちでないですか？ <a href="#" id="signUpLink">サインアップ</a></p>
        </form>
        <form id="signUpForm" style="display:none;">
            <label for="name">名前:</label>
            <input type="text" id="name" name="name" required>
            <label for="signUpEmail">メールアドレス:</label>
            <input type="email" id="signUpEmail" name="signUpEmail" required>
            <label for="signUpPassword">パスワード:</label>
            <input type="password" id="signUpPassword" name="signUpPassword" required>
            <button type="submit">サインアップ</button>
            <p>すでにアカウントをお持ちですか？ <a href="#" id="loginLink">ログイン</a></p>
        </form>
    </div>
    
    <div id="boardPage" class="page" style="display:none;">
        <h1>投稿掲示板</h1>
        <form id="postForm">
            <label for="comment">コメント:</label>
            <textarea id="comment" name="comment" required></textarea>
            <label for="file">画像・動画添付:</label>
            <input type="file" id="file" name="file" accept="image/*,video/*">
            <button type="submit">投稿</button>
        </form>
        <div id="posts"></div>
        <button id="logoutButton">ログアウト</button>
    </div>

    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-storage.js"></script> <!-- Firebase Storage追加 -->

    <script>
        // Firebase設定を貼り付け
        const firebaseConfig = {
            apiKey: "AIzaSyDsK4imQ3uWcK7hyESo6hnDyQ96lsPNCZ8",
            authDomain: "nou-no-circle.firebaseapp.com",
            projectId: "nou-no-circle",
            storageBucket: "nou-no-circle.appspot.com",
            messagingSenderId: "756338805186",
            appId: "1:756338805186:web:cb740e035ac611b5baae5b",
            measurementId: "G-TWBV38P13D"
        };

        // Firebase初期化
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage(); // Firebase Storageの初期化

        document.addEventListener('DOMContentLoaded', function() {
            const loginForm = document.getElementById('loginForm');
            const signUpForm = document.getElementById('signUpForm');
            const signUpLink = document.getElementById('signUpLink');
            const loginLink = document.getElementById('loginLink');
            const postForm = document.getElementById('postForm');
            const logoutButton = document.getElementById('logoutButton');

            // ログインフォームの送信イベント
            loginForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                auth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        document.getElementById('loginPage').style.display = 'none';
                        document.getElementById('boardPage').style.display = 'block';
                        loadPosts();
                    })
                    .catch((error) => {
                        alert(error.message);
                    });
            });

            // サインアップフォームの送信イベント
            signUpForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const email = document.getElementById('signUpEmail').value;
                const password = document.getElementById('signUpPassword').value;
                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        alert('サインアップが成功しました。ログインしてください。');
                        signUpForm.style.display = 'none';
                        loginForm.style.display = 'block';
                    })
                    .catch((error) => {
                        alert(error.message);
                    });
            });

            // サインアップリンククリックイベント
            signUpLink.addEventListener('click', function() {
                loginForm.style.display = 'none';
                signUpForm.style.display = 'block';
            });

            // ログインリンククリックイベント
            loginLink.addEventListener('click', function() {
                signUpForm.style.display = 'none';
                loginForm.style.display = 'block';
            });

            // 投稿フォームの送信イベント
            postForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const comment = document.getElementById('comment').value;
                const file = document.getElementById('file').files[0];
                const user = auth.currentUser;

                if (comment && user) {
                    if (file) {
                        const storageRef = storage.ref();
                        const fileRef = storageRef.child(`uploads/${user.uid}/${file.name}`);
                        fileRef.put(file).then(() => {
                            fileRef.getDownloadURL().then((url) => {
                                db.collection('posts').add({
                                    uid: user.uid,
                                    comment: comment,
                                    fileUrl: url,
                                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                                })
                                .then(() => {
                                    document.getElementById('comment').value = '';
                                    document.getElementById('file').value = '';
                                    loadPosts();
                                })
                                .catch((error) => {
                                    alert(error.message);
                                });
                            });
                        });
                    } else {
                        db.collection('posts').add({
                            uid: user.uid,
                            comment: comment,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        })
                        .then(() => {
                            document.getElementById('comment').value = '';
                            loadPosts();
                        })
                        .catch((error) => {
                            alert(error.message);
                        });
                    }
                } else {
                    alert('コメントを入力してください');
                }
            });

            // ログアウトボタンクリックイベント
            logoutButton.addEventListener('click', function() {
                auth.signOut().then(() => {
                    document.getElementById('boardPage').style.display = 'none';
                    document.getElementById('loginPage').style.display = 'block';
                });
            });

            // 投稿の読み込み
            function loadPosts() {
                db.collection('posts').orderBy('timestamp', 'desc').get().then((querySnapshot) => {
                    const postsDiv = document.getElementById('posts');
                    postsDiv.innerHTML = '';
                    querySnapshot.forEach((doc) => {
                        const postData = doc.data();
                        const postDiv = document.createElement('div');
                        postDiv.className = 'post';
                        postDiv.innerText = postData.comment;
                        if (postData.fileUrl) {
                            const fileElement = document.createElement(postData.fileUrl.includes('video') ? 'video' : 'img');
                            fileElement.src = postData.fileUrl;
                            fileElement.controls = true;
                            postDiv.appendChild(fileElement);
                        }
                        postsDiv.appendChild(postDiv);
                    });
                });
            }

            // 認証状態の変更を監状態を監視
        auth.onAuthStateChanged((user) => {
        if (user) {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('boardPage').style.display = 'block';
            loadPosts();
        } else {
            document.getElementById('loginPage').style.display = 'block';
            document.getElementById('boardPage').style.display = 'none';
        }
    });
});
</script>

</body>
</html>
